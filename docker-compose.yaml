# Hydra explorer instance with it's chain observers as it is deployed to
# explorer.hydra.family
networks:
  hydra-explorer:
    driver: bridge

services:
  hydra-explorer:
    image: ghcr.io/cardano-scaling/hydra-explorer:unstable
    ports:
      - "80:8000"
    command:
      [ "--client-port", "8000"
      , "--observer-port", "8001" # not bound to host
      ]
    networks:
      - hydra-explorer
    restart: always

  # List of hydra-chain-observers

  ## 0.20

  hydra-chain-observer-preview-0.20:
    # TODO: cut release 0.20.1
    image: ghcr.io/cardano-scaling/hydra-chain-observer@sha256:83f56e88522e48ae6436015cb7e90a1633e0e2312846ac8ad203ea9760e6af8b
    volumes:
      - "/data/cardano/preview:/data"
    command:
      [ "--node-socket", "/data/node.socket"
      , "--testnet-magic", "2"
      # NOTE: Block in which 0.20.0 scripts were published
      , "--start-chain-from", "71938562.2c5fc734343ad1bf8ce2df999421cca15dffdd2b8e1909dad7127b9eaacf8b9c"
      # NOTE: Reachable via hydra-explorer network
      , "--explorer", "http://hydra-explorer:8001"
      ]
    networks:
      - hydra-explorer
    restart: always

  hydra-chain-observer-preprod-0.20:
    # TODO: cut release 0.20.1
    image: ghcr.io/cardano-scaling/hydra-chain-observer@sha256:83f56e88522e48ae6436015cb7e90a1633e0e2312846ac8ad203ea9760e6af8b
    volumes:
      - "/data/cardano/preprod:/data"
    command:
      [ "--node-socket", "/data/node.socket"
      , "--testnet-magic", "1"
      # NOTE: Block in which 0.20.0 scripts were published
      , "--start-chain-from", "82913877.aa62d900ecbd6a073e1b5bb8c014413365c26a3675bd81dc567013340bf94ec3"
      # NOTE: Reachable via hydra-explorer network
      , "--explorer", "http://hydra-explorer:8001"
      ]
    networks:
      - hydra-explorer
    restart: always

  ## 0.19

  hydra-chain-observer-preview-0.19:
    # TODO: cut release 0.19.1
    image: ghcr.io/cardano-scaling/hydra-chain-observer@sha256:c1cd148650c844d19cbb319de9abbff7324f5b18891b475b54de2250edee5626
    volumes:
      - "/data/cardano/preview:/data"
    command:
      [ "--node-socket", "/data/node.socket"
      , "--testnet-magic", "2"
      # NOTE: Block in which 0.19.0 scripts were published
      , "--start-chain-from", "59574002.1ba4ee1f87e8ebbf4682662839592639591133d589a8a84246bbb3c7ce2b713b"
      # NOTE: Reachable via hydra-explorer network
      , "--explorer", "http://hydra-explorer:8001"
      ]
    networks:
      - hydra-explorer
    restart: always

  hydra-chain-observer-preprod-0.19:
    # TODO: cut release 0.19.1
    image: ghcr.io/cardano-scaling/hydra-chain-observer@sha256:c1cd148650c844d19cbb319de9abbff7324f5b18891b475b54de2250edee5626
    volumes:
      - "/data/cardano/preprod:/data"
    command:
      [ "--node-socket", "/data/node.socket"
      , "--testnet-magic", "1"
      # NOTE: Block in which 0.19.0 scripts were published
      , "--start-chain-from", "70548651.03f8deb122fbbd98af8eb58ef56feda37728ec957d39586b78198a0cf624412a"
      # NOTE: Reachable via hydra-explorer network
      , "--explorer", "http://hydra-explorer:8001"
      ]
    networks:
      - hydra-explorer
    restart: always

  # One cardano node per network

  cardano-node-preview:
    image: ghcr.io/intersectmbo/cardano-node:10.1.4
    volumes:
      - /data/cardano/preview:/data
    environment:
      - CARDANO_CONFIG=/data/config.json
      - CARDANO_TOPOLOGY=/data/topology.json
      - CARDANO_DATABASE_PATH=/data/db
      - CARDANO_SOCKET_PATH=/data/node.socket # used by cardano-node
      - CARDANO_NODE_SOCKET_PATH=/data/node.socket # used by cardano-cli
      - CARDANO_LOG_DIR=/data/logs
    command:
      [ "run" ]
    restart: always

  cardano-node-preprod:
    image: ghcr.io/intersectmbo/cardano-node:10.1.4
    volumes:
      - /data/cardano/preprod:/data
    environment:
      - CARDANO_CONFIG=/data/config.json
      - CARDANO_TOPOLOGY=/data/topology.json
      - CARDANO_DATABASE_PATH=/data/db
      - CARDANO_SOCKET_PATH=/data/node.socket # used by cardano-node
      - CARDANO_NODE_SOCKET_PATH=/data/node.socket # used by cardano-cli
      - CARDANO_LOG_DIR=/data/logs
    command:
      [ "run" ]
    restart: always
